<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Detalhes do Hotel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Font Awesome (apenas a versão 6) e Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- CSS do Carrinho -->
  <link rel="stylesheet" href="css/cart.css">

  <script src="/js/afcop.js" defer></script>
  
  <!-- Script extra (ex.: facilitiesMap.js) -->
  <script src="/js/facilitiesMap.js" defer></script>
  
  <!-- Carrega o Web Component do Carrinho -->
  <script src="/js/cart-component.js" defer></script>
  <script src="/js/header-component.js" type="module"></script>
  
  <style>
    /* RESET e estilos básicos para hoteldetails */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background-color: #f0f2f5; color: #333; line-height: 1.6; }
    .main-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* Cabeçalho do Hotel */
    .hotel-header { margin-bottom: 20px; }
    .hotel-name { font-size: 2em; font-weight: bold; color: #333; }
    .hotel-address { display: flex; align-items: center; font-size: 1em; color: #666; margin-top: 10px; }
    .hotel-address i { color: var(--primary_color); margin-right: 10px; }
    .location-link { color: var(--primary_color); text-decoration: none; margin-left: 10px; font-weight: bold; cursor: pointer; }
    .location-link:hover { text-decoration: underline; color: var(--button_hover); }
    
    /* Galeria de Fotos */
    .photo-gallery { display: grid; grid-template-columns: 2fr 1fr 1fr; grid-template-rows: repeat(2, 200px); gap: 10px; margin-bottom: 20px; }
    .photo-gallery img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .photo-gallery .large-photo { grid-row: 1 / 3; }
    
    /* Comodidades */
    .facilities { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .facility { display: flex; align-items: center; justify-content: center; padding: 15px; background-color: #fff; border-radius: 10px; border: 1px solid #ddd; text-align: center; transition: box-shadow 0.3s; }
    .facility i { font-size: 1.5em; color: var(--primary_color); margin-right: 10px; }
    .facility:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    
    /* Descrição e Destaques */
    .description-container { display: flex; gap: 20px; margin-top: 20px; }
    .description { flex: 2; padding: 20px; border-right: 1px solid #e0e0e0; }
    .highlights { flex: 1; padding: 20px; background-color: var(--background_color, #e9f7fe); border-radius: 8px; border: 2px solid var(--primary_color); }
    .highlights h2 { font-size: 1.8em; color: var(--primary_color); margin-bottom: 10px; text-align: center; font-weight: bold; }
    .highlights h3 { margin: 15px 0; color: #343a40; }
    .highlight-list { list-style: none; padding: 0; margin-bottom: 20px; }
    .highlight-list li { margin-bottom: 8px; padding-left: 30px; position: relative; color: #555; font-size: 1.1em; }
    .highlight-list li i { position: absolute; left: 0; color: var(--primary_color); font-size: 1.2em; }
    
    /* Barra de Busca */
    .search-bar-container { display: flex; align-items: center; gap: 15px; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
    .search-fields { display: flex; align-items: center; gap: 15px; flex: 1; }
    .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
    .input-group label { font-size: 12px; color: #555; margin-left: 5px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; color: #333; }
    .search-button {
      background-color: var(--button_color);
      color: var(--button_text_color);
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      flex-shrink: 0;
      height: 56px;
      font-size: 16px;
    }
    .search-button:hover {
      background-color: var(--button_hover);
    }
    
    /* Tabela de Quartos */
    .room-table { width: 100%; margin-top: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
    .room-table-header {
      display: grid;
      grid-template-columns: 3fr 1fr 2fr 1fr;
      background-color: var(--primary_color);
      padding: 15px;
      font-weight: bold;
      color: #fff;
      text-align: center;
    }
    .room-group-title { grid-column: 1 / 5; background-color: #f5f7ff; font-weight: 700; font-size: 1.1em; padding: 10px; border-bottom: 1px solid #ddd; }
    .room-table-row { display: grid; grid-template-columns: 3fr 1fr 2fr 1fr; padding: 15px; align-items: center; border-bottom: 1px solid #ddd; }
    .room-info { display: flex; gap: 15px; align-items: center; }
    .room-image { width: 150px; height: 100px; border-radius: 10px; object-fit: cover; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .room-details { display: flex; flex-direction: column; }
    .room-details h4 { margin-bottom: 10px; font-size: 1em; color: var(--primary_color); }
    .room-details p { margin: 5px 0; color: #666; }
    .room-price { font-size: 0.8em; font-weight: bold; color: #666; text-align: center; }
    .price-info { text-align: center; font-size: 0.8em; color: #666; }
    .discount-price { font-size: 1.2em; font-weight: bold; color: var(--primary_color); margin: 0; padding: 0; }
    .installment-info { font-size: 0.9rem; color: #666; }
    .select-room-button {
      background-color: var(--button_color);
      color: var(--button_text_color);
      padding: 10px 20px;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 1em;
      border: none;
    }
    .select-room-button:hover {
      background-color: var(--button_hover);
    }
    
    /* Informações Adicionais */
    .info-container { margin-top: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; }
    .info-block {
      flex: 1;
      min-width: 230px;
      margin: 10px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .info-block h3 { font-size: 1.2em; color: var(--primary_color); font-weight: 600; }
    .info-block p { font-size: 1em; color: #555; }
    
    /* Mapa e Atrações */
    .container {
      display: flex;
      width: 100%;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      background-color: #fff;
      margin-top: 20px;
    }
    .attractions {
      width: 35%;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #f2f2f2;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-right: 20px;
      display: flex;
      flex-direction: column;
    }
    #map { height: 400px; width: 65%; }
    .attraction-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: background-color 0.3s;
      font-size: 16px;
      width: 100%;
    }
    .attraction-item:hover { background-color: #e0f7fa; }
    .attraction-item i { margin-right: 10px; color: var(--primary_color); font-size: 20px; }
    
    h2 { text-align: center; color: #333; margin-bottom: 20px; }
    footer { text-align: center; margin-top: 20px; color: #666; }
  </style>
</head>
<body>
  <!-- HEADER: Carregado via fetch -->
  <app-header></app-header>

  <!-- CARRINHO: Web Component (múltiplos itens via addItem()) -->
  <shopping-cart 
    type="HOSPEDAGEM" 
    category="Hospedagem" 
    nameDays="Quarto e Hotel" 
    date="2025-04-12"
    basePriceAdult="80"
    basePriceChild="60">
  </shopping-cart>

  <!-- CONTEÚDO PRINCIPAL DO HOTEL DETAILS -->
  <div class="main-container" id="hotelDetail">
    <!-- Cabeçalho do Hotel -->
    <div class="hotel-header">
      <div class="hotel-name" id="hotelName"></div>
      <div class="hotel-address" id="hotelAddress"></div>
    </div>

    <!-- Galeria de Fotos -->
    <div class="photo-gallery" id="photoGallery"></div>

    <!-- Seção de Comodidades -->
    <section class="facilities" id="facilities"></section>

    <!-- Descrição e Destaques -->
    <div class="description-container">
      <div class="description" id="hotelDescription"></div>
      <div class="highlights" id="hotelHighlights"></div>
    </div>

    <!-- Barra de Busca -->
    <div class="search-bar-container" id="searchBar">
      <div class="search-fields">
        <div class="input-group">
          <label for="checkin-checkout">Datas</label>
          <!-- Usaremos Flatpickr para seleção de intervalo -->
          <input type="text" id="checkin-checkout" placeholder="Selecione o período">
        </div>
        <div class="input-group">
          <label for="rooms">Quartos</label>
          <input type="number" id="rooms" placeholder="Nº de Quartos" min="1" max="10" value="1">
        </div>
        <div class="input-group">
          <label for="adults">Adultos (+18 Anos)</label>
          <input type="number" id="adults" placeholder="Nº de Adultos" min="1" max="10" value="1">
        </div>
        <div class="input-group">
          <label for="children">Crianças (0 a 17 anos)</label>
          <input type="number" id="children" placeholder="Nº de Crianças" min="0" max="10" value="0">
        </div>
      </div>
      <button class="search-button" onclick="updateRoomList()">Pesquisar</button>
    </div>

    <!-- Tabela de Quartos -->
    <section class="room-table" id="roomTable">
      <div class="room-table-header">
        <div>Tipo de Quarto</div>
        <div>Hóspedes</div>
        <div>Preço para <span id="num-noites">0</span> Noites</div>
        <div></div>
      </div>
      <div class="room-table-body" id="roomTableBody"></div>
    </section>

    <!-- Informações Adicionais -->
    <div class="info-container" id="infoContainer"></div>

    <!-- Mapa e Atrações -->
    <div class="container" id="mapAttractionsContainer">
      <div class="attractions" id="attractions">
        <h2>Atrações</h2>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- SCRIPTS EXTERNOS -->
  <!-- Inclui jQuery e Moment.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- Inclui Flatpickr (em vez do daterangepicker) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Inclui Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SCRIPT PRINCIPAL UNIFICADO -->
  <script>
  (function() {
    if (window.__hotelDetailJSInitialized) return;
    window.__hotelDetailJSInitialized = true;

    // 2. Função global para abrir o carrinho
    window.toggleCart = function() {
      const cartComponent = document.querySelector("shopping-cart");
      if (cartComponent && typeof cartComponent.openCart === "function") {
        cartComponent.openCart();
      } else {
        console.error("Componente <shopping-cart> não encontrado ou openCart() não definido.");
      }
    };

    // 3. Função auxiliar para obter parâmetros da URL
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      const query = {};
      for (const [key, value] of params.entries()) {
        query[key] = value;
      }
      return query;
    }

    // 4. Função que consulta a taxa do dólar via API (Supabase)
    function getDollarRate() {
      return fetch("/api/getLatestDollar")
        .then(resp => resp.json())
        .then(data => {
          if (data && data.valor) {
            return parseFloat(data.valor);
          }
          return 1;
        })
        .catch(err => {
          console.error("Erro ao obter a taxa do dólar:", err);
          return 1;
        });
    }

    // 5. Função que busca os dados combinados do hotel (Booking + Content API)
    function fetchHotelCombined() {
      const dateRange = document.getElementById("checkin-checkout").value;
      let checkIn = "";
      let checkOut = "";
      if (dateRange.includes(" - ")) {
        const [startStr, endStr] = dateRange.split(" - ");
        checkIn = moment(startStr, "DD/MM/YYYY").format("YYYY-MM-DD");
        checkOut = moment(endStr, "DD/MM/YYYY").format("YYYY-MM-DD");
      }
      const rooms = document.getElementById("rooms").value || 1;
      const adults = document.getElementById("adults").value || 1;
      const children = document.getElementById("children").value || 0;

      const queryParams = new URLSearchParams(window.location.search);
      const hotelCode = queryParams.get("hotelCode") || "";

      const params = new URLSearchParams();
      if (checkIn) params.set("checkIn", checkIn);
      if (checkOut) params.set("checkOut", checkOut);
      params.set("rooms", rooms);
      params.set("adults1", adults);
      params.set("children1", children);
      if (hotelCode) params.set("hotelCode", hotelCode);

      return fetch(`/api/hbdetail/hotels?${params.toString()}`)
        .then(resp => resp.json());
    }

    // 6. Função que preenche os dados do hotel na página
    async function loadHotelContent(hotelObj, dollarRate) {
      if (!hotelObj) return;
      const hotelName = hotelObj.name || "Hotel sem nome";
      const hotelCode = hotelObj.code;
      const hotelAddress = hotelObj.destinationName || "";
      document.getElementById("hotelName").textContent = hotelName;
      document.getElementById("hotelAddress").innerHTML = `
        <i class="fas fa-map-marker-alt"></i> ${hotelAddress}
        <a href="#" class="location-link" onclick="toggleCart()">Abrir Carrinho</a>
      `;

      // Galeria de fotos
      let images = [];
      if (hotelObj.content && hotelObj.content.images && hotelObj.content.images.length) {
        images = hotelObj.content.images.map(img => "https://photos.hotelbeds.com/giata/xl/" + img.path);
      }
      fillPhotoGallery(images);

      // Preenche a seção de facilities exclusivamente via Content API
      fetchHotelFacilities(hotelCode);

      // Descrição e Destaques
      if (hotelObj.content && hotelObj.content.description) {
        document.getElementById("hotelDescription").innerHTML = hotelObj.content.description;
      }
      document.getElementById("hotelHighlights").innerHTML = `
        <h2>Destaques da Acomodação</h2>
        <p>Confira as melhores vantagens desta acomodação.</p>
      `;

      // Tabela de Quartos e Informações Adicionais
      createRoomTableGrouped(hotelObj.rooms, hotelCode, hotelName, dollarRate);
      fillInfoBlocks({
        checkin: "A partir das 16h",
        checkout: "Até 11:00",
        resortFee: "Não possui no local.",
        parking: "Consulte valores no local."
      });

      // Mapa e Atrações
      const lat = hotelObj.latitude || 0;
      const lng = hotelObj.longitude || 0;
      let interestPoints = [];
      if (hotelObj.content && hotelObj.content.interestPoints) {
        interestPoints = hotelObj.content.interestPoints;
      }
      initMapAndAttractions(lat, lng, interestPoints);
    }

    // 7. Preenche a galeria de fotos
    function fillPhotoGallery(photos) {
      const gallery = document.getElementById("photoGallery");
      gallery.innerHTML = "";
      if (!photos || !photos.length) return;
      const largeImg = document.createElement("img");
      largeImg.src = photos[0];
      largeImg.alt = "Foto do Hotel";
      largeImg.classList.add("large-photo");
      gallery.appendChild(largeImg);
      for (let i = 1; i < photos.length && i < 5; i++) {
        const img = document.createElement("img");
        img.src = photos[i];
        img.alt = "Foto do Hotel";
        gallery.appendChild(img);
      }
    }

    // 8. Preenche as facilidades (facilities) no container
    const facilitiesMap = {
      "Year of most recent renovation": {
        pt: "Ano da última renovação",
        icon: "fa-solid fa-history"
      },
      "Number of floors (main building)": {
        pt: "Número de andares (prédio principal)",
        icon: "fa-solid fa-building"
      },
      "Disability-friendly rooms": {
        pt: "Quartos adaptados para pessoas com deficiência",
        icon: "fa-solid fa-wheelchair"
      },
      "American Express": {
        pt: "American Express",
        icon: "fab fa-cc-amex"
      },
      "JCB": {
        pt: "JCB",
        icon: "fab fa-cc-jcb"
      },
      "Diners Club": {
        pt: "Diners Club",
        icon: "fab fa-cc-diners-club"
      },
      "MasterCard": {
        pt: "Mastercard",
        icon: "fab fa-cc-mastercard"
      },
      "Visa": {
        pt: "Visa",
        icon: "fab fa-cc-visa"
      },
      "City centre": {
        pt: "Centro da cidade",
        icon: "fa-solid fa-city"
      },
      "Bus/Train station": {
        pt: "Estação de ônibus/trem",
        icon: "fa-solid fa-bus"
      },
      "Nearest Bus / Metro Stop": {
        pt: "Ponto de ônibus / metrô mais próximo",
        icon: "fa-solid fa-subway"
      },
      "Airport": {
        pt: "Aeroporto",
        icon: "fa-solid fa-plane"
      },
      "Beach": {
        pt: "Praia",
        icon: "fa-solid fa-umbrella-beach"
      },
      "Golf course": {
        pt: "Campo de golfe",
        icon: "fa-solid fa-golf-ball"
      },
      "Entertainment Area": {
        pt: "Área de entretenimento",
        icon: "fa-solid fa-theater-masks"
      },
      "Number of bedrooms": {
        pt: "Número de quartos",
        icon: "fa-solid fa-bed"
      },
      "Living room": {
        pt: "Sala de estar",
        icon: "fa-solid fa-couch"
      },
      "Disability-friendly bathroom": {
        pt: "Banheiro adaptado",
        icon: "fa-solid fa-toilet"
      },
      "Hairdryer": {
        pt: "Secador de cabelo",
        icon: "fa-solid fa-wind"
      },
      "Bathrobes": {
        pt: "Roupões de banho",
        icon: "fa-solid fa-tshirt"
      },
      "Wi-fi": {
        pt: "Wi-Fi",
        icon: "fa-solid fa-wifi"
      },
      "Internet access": {
        pt: "Acesso à internet",
        icon: "fa-solid fa-wifi"
      },
      "Cable TV": {
        pt: "TV a cabo",
        icon: "fa-solid fa-tv"
      },
      "Pay movies": {
        pt: "Filmes pagos",
        icon: "fa-solid fa-film"
      },
      "Alarm clock": {
        pt: "Despertador",
        icon: "fa-solid fa-clock"
      },
      "Safe": {
        pt: "Cofre",
        icon: "fa-solid fa-lock"
      },
      "Wheelchair-accessible": {
        pt: "Acessível para cadeira de rodas",
        icon: "fa-solid fa-wheelchair"
      },
      "Wake-up service": {
        pt: "Serviço de despertar",
        icon: "fa-solid fa-bell"
      },
      "Smoking rooms": {
        pt: "Quartos para fumantes",
        icon: "fa-solid fa-smoking"
      },
      "Extra beds on demand": {
        pt: "Camas extras sob demanda",
        icon: "fa-solid fa-bed"
      },
      "Cot on demand": {
        pt: "Berço sob demanda",
        icon: "fa-solid fa-baby"
      },
      "Car park": {
        pt: "Estacionamento",
        icon: "fa-solid fa-parking"
      },
      "24-hour reception": {
        pt: "Recepção 24h",
        icon: "fa-solid fa-concierge-bell"
      },
      "Check-in hour": {
        pt: "Horário de check-in",
        icon: "fa-solid fa-sign-in-alt"
      },
      "Check-out hour": {
        pt: "Horário de check-out",
        icon: "fa-solid fa-sign-out-alt"
      },
      "Late Check-out": {
        pt: "Late check-out",
        icon: "fa-solid fa-clock"
      },
      "Wired Internet": {
        pt: "Internet com fio",
        icon: "fa-solid fa-network-wired"
      },
      "Secure parking": {
        pt: "Estacionamento seguro",
        icon: "fa-solid fa-lock"
      },
      "Valet parking": {
        pt: "Manobrista",
        icon: "fa-solid fa-car"
      },
      "Room service": {
        pt: "Serviço de quarto",
        icon: "fa-solid fa-concierge-bell"
      },
      "Laundry service": {
        pt: "Serviço de lavanderia",
        icon: "fa-solid fa-tshirt"
      },
      "Launderette": {
        pt: "Lavanderia self-service",
        icon: "fa-solid fa-tshirt"
      },
      "Multilingual staff": {
        pt: "Equipe multilíngue",
        icon: "fa-solid fa-language"
      },
      "24-hour security": {
        pt: "Segurança 24h",
        icon: "fa-solid fa-shield-alt"
      },
      "Air conditioning in public areas": {
        pt: "Ar-condicionado em áreas públicas",
        icon: "fa-solid fa-fan"
      },
      "Fireplace": {
        pt: "Lareira",
        icon: "fa-solid fa-fire"
      },
      "Hotel safe": {
        pt: "Cofre do hotel",
        icon: "fa-solid fa-lock"
      },
      "Lift access": {
        pt: "Acesso por elevador",
        icon: "fa-solid fa-arrow-up"
      },
      "Gym": {
        pt: "Academia",
        icon: "fa-solid fa-dumbbell"
      },
      "Newspapers": {
        pt: "Jornais",
        icon: "fa-solid fa-newspaper"
      },
      "Luggage room": {
        pt: "Depósito de bagagem",
        icon: "fa-solid fa-suitcase"
      },
      "Clothes dryer": {
        pt: "Secadora de roupas",
        icon: "fa-solid fa-tshirt"
      },
      "Bar": {
        pt: "Bar",
        icon: "fa-solid fa-glass-martini-alt"
      },
      "Restaurant": {
        pt: "Restaurante",
        icon: "fa-solid fa-utensils"
      },
      "Non-smoking area": {
        pt: "Área para não fumantes",
        icon: "fa-solid fa-smoking-ban"
      },
      "Smoking area": {
        pt: "Área para fumantes",
        icon: "fa-solid fa-smoking"
      },
      "Highchairs": {
        pt: "Cadeiras altas",
        icon: "fa-solid fa-chair"
      },
      "Poolside snack bar": {
        pt: "Bar de lanches à beira da piscina",
        icon: "fa-solid fa-cocktail"
      },
      "Banquet hall": {
        pt: "Salão de banquetes",
        icon: "fa-solid fa-utensils"
      },
      "Meeting room": {
        pt: "Sala de reuniões",
        icon: "fa-solid fa-door-open"
      },
      "Photocopier": {
        pt: "Fotocopiadora",
        icon: "fa-solid fa-copy"
      },
      "Business centre": {
        pt: "Centro de negócios",
        icon: "fa-solid fa-briefcase"
      },
      "Audio-visual equipment rental": {
        pt: "Aluguel de equipamento audiovisual",
        icon: "fa-solid fa-video"
      },
      "Fax": {
        pt: "Fax",
        icon: "fa-solid fa-fax"
      },
      "Outdoor freshwater pool": {
        pt: "Piscina externa de água doce",
        icon: "fa-solid fa-swimming-pool"
      },
      "Outdoor heated pool": {
        pt: "Piscina externa aquecida",
        icon: "fa-solid fa-swimming-pool"
      },
      "Sun loungers": {
        pt: "Espreguiçadeiras",
        icon: "fa-solid fa-chair"
      },
      "Parasols": {
        pt: "Sombrinhas",
        icon: "fa-solid fa-umbrella"
      },
      "TV lounge": {
        pt: "Sala de TV",
        icon: "fa-solid fa-tv"
      },
      "Breakfast": {
        pt: "Café da manhã",
        icon: "fa-solid fa-coffee"
      },
      "Continental breakfast": {
        pt: "Café da manhã continental",
        icon: "fa-solid fa-mug-hot"
      },
      "Snacks": {
        pt: "Lanches",
        icon: "fa-solid fa-cookie-bite"
      },
      "LGTBIQ friendly": {
        pt: "Amigável para LGTBIQ",
        icon: "fa-solid fa-heart"
      },
      "Deposit on arrival": {
        pt: "Depósito na chegada",
        icon: "fa-solid fa-piggy-bank"
      },
      "Charges for late arrival": {
        pt: "Taxas por chegada tardia",
        icon: "fa-solid fa-money-bill-wave"
      },
      "Identification card at arrival": {
        pt: "Carteira de identidade na chegada",
        icon: "fa-solid fa-id-card"
      },
      "Non-smoking establishment": {
        pt: "Estabelecimento para não fumantes",
        icon: "fa-solid fa-smoking-ban"
      },
      "Minimum check-in age": {
        pt: "Idade mínima para check-in",
        icon: "fa-solid fa-user-check"
      },
      "Jet ski": {
        pt: "Jet ski",
        icon: "fa-solid fa-ship"
      },
      "Windsurfing": {
        pt: "Windsurf",
        icon: "fa-solid fa-wind"
      },
      "Sailing": {
        pt: "Vela",
        icon: "fa-solid fa-ship"
      },
      "Canoeing": {
        pt: "Canoagem",
        icon: "fa-solid fa-water"
      },
      "Fitness": {
        pt: "Academia",
        icon: "fa-solid fa-dumbbell"
      },
      "Horse riding": {
        pt: "Equitação",
        icon: "fa-solid fa-horse"
      },
      "Basketball": {
        pt: "Basquete",
        icon: "fa-solid fa-basketball-ball"
      },
      "Billiards": {
        pt: "Sinuca",
        icon: "fa-solid fa-circle" // Placeholder para sinuca
      },
      "Bowling alley": {
        pt: "Pista de boliche",
        icon: "fa-solid fa-bowling-ball"
      },
      "Tennis": {
        pt: "Tênis",
        icon: "fa-solid fa-table-tennis-paddle-ball"
      },
      "Hilton - CleanStay": {
        pt: "Hilton - CleanStay",
        icon: "fa-solid fa-hotel"
      }
    };
    
    function getFacilityData(key) {
      return facilitiesMap[key] || null;
    }
    
    function processFacility(item) {
      const mapping = getFacilityData(item);
      if (mapping) {
        const iconElement = document.createElement('i');
        iconElement.className = mapping.icon;
        const container = document.createElement('div');
        container.style.margin = "10px";
        container.innerHTML = `<strong>${mapping.pt}</strong>`;
        container.appendChild(iconElement);
        document.body.appendChild(container);
      } else {
        console.log(item, "não faz parte de facilitiesMap");
      }
    }
    
    /**
     * Preenche o container com até 12 facilities válidas.
     * Se algum item não tiver mapeamento, ele será ignorado e os próximos serão processados,
     * até que se exibam 12 ou o array acabe.
     */
    function fillFacilities(facilities) {
      const container = document.getElementById("facilities");
      if (!container) return;
      container.innerHTML = "";
      if (!facilities || facilities.length === 0) return;
      
      let count = 0;
      for (let i = 0; i < facilities.length && count < 12; i++) {
        // Utiliza facility.code como chave ou, se não existir, facility.description.content
        const facility = facilities[i];
        const key = facility.code || facility.description?.content;
        const mapping = getFacilityData(key);
        if (mapping) {
          container.innerHTML += `<div class="facility"><i class="${mapping.icon}"></i> ${mapping.pt}</div>`;
          count++;
        }
      }
    }
    
    export { facilitiesMap, getFacilityData, processFacility, fillFacilities };

    // 9. Função para buscar facilities via Content API exclusivamente
    function fetchHotelFacilities(hotelCode) {
      fetch(`https://business.airland.com.br/api/hotelbeds/hotel-content?hotelCode=${hotelCode}`)
        .then(response => response.json())
        .then(data => {
          if (data.hotel) {
            const facilities = data.hotel.facilities || [];
            fillFacilities(facilities);
          } else {
            console.warn("Nenhum dado encontrado para o hotel com o hotelCode:", hotelCode);
          }
        })
        .catch(err => console.error("Erro ao buscar dados do Content API:", err));
    }

    // 10. Cria a tabela de quartos
    function createRoomTableGrouped(rooms, hotelCode, hotelName, dollarRate) {
      const tableBody = document.getElementById("roomTableBody");
      tableBody.innerHTML = "";
      if (!rooms || !rooms.length) return;
      const sortedRooms = rooms.slice().sort((a, b) => {
        const netA = a.rates?.[0]?.net ? parseFloat(a.rates[0].net) : Infinity;
        const netB = b.rates?.[0]?.net ? parseFloat(b.rates[0].net) : Infinity;
        return netA - netB;
      });
      const initialCount = 6;
      const roomsToShow = sortedRooms.slice(0, initialCount);
      roomsToShow.forEach(room => {
        tableBody.appendChild(createRoomRow(room, hotelCode, hotelName, dollarRate));
      });
      if (sortedRooms.length > initialCount) {
        const moreButton = document.createElement("button");
        moreButton.textContent = "Mostrar mais quartos";
        moreButton.className = "select-room-button";
        moreButton.onclick = function() {
          moreButton.remove();
          const remainingRooms = sortedRooms.slice(initialCount);
          remainingRooms.forEach(r => {
            tableBody.appendChild(createRoomRow(r, hotelCode, hotelName, dollarRate));
          });
        };
        const btnRow = document.createElement("div");
        btnRow.className = "room-table-row";
        btnRow.style.justifyContent = "center";
        btnRow.appendChild(moreButton);
        tableBody.appendChild(btnRow);
      }
    }

    // 11. Cria cada linha (quarto) da tabela com preços formatados
    function createRoomRow(room, hotelCode, hotelName, dollarRate) {
      const roomName = room.name || room.roomType || room.roomCode || "Quarto";
      let netPrice = room.rates && room.rates[0]?.net ? room.rates[0].net : 80;
      const netVal = parseFloat(netPrice);

      const convertedPrice = netVal * dollarRate;
      const numNoites = parseInt(document.getElementById("num-noites").textContent) || 1;
      const totalPrice = convertedPrice * numNoites;

      const finalPriceFormatted = totalPrice.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      });
      const discount = totalPrice * 0.05;
      const discountFormatted = discount.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      });
      const dailyRate = totalPrice / numNoites;
      const dailyRateFormatted = dailyRate.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      });

      const finalPrice = parseFloat(totalPrice.toFixed(2));

      const row = document.createElement("div");
      row.className = "room-table-row";
      row.innerHTML = `
        <div class="room-info">
          <div class="room-details">
            <h4>${roomName}</h4>
          </div>
        </div>
        <div class="room-guests">${room.maxPax || 2} Hóspedes</div>
        <div class="room-price" data-price="${netVal}">
          <p class="discount-price">${finalPriceFormatted}</p>
          <p class="installment-info">até 10x sem juros</p>
          <p class="pix-off">Economize ${discountFormatted} no Pix</p>
          <p class="daily-price">Preço por diária: ${dailyRateFormatted}</p>
        </div>
        <div>
          <button class="select-room-button"
            onclick="handleSelectRoom('${hotelCode}', '${hotelName}', '${room.code}', '${room.name}', '${finalPrice}', '60')">
            Selecionar Quarto
          </button>
        </div>
      `;
      return row;
    }

    // 12. Preenche os blocos de informações adicionais
    function fillInfoBlocks(info) {
      const container = document.getElementById("infoContainer");
      container.innerHTML = "";
      if (!info) return;
      const items = [
        { title: "Horário de Check-in (Entrada)", icon: "fas fa-clock", content: info.checkin },
        { title: "Horário de Check-out (Saída)", icon: "fas fa-clock", content: info.checkout },
        { title: "Resort Fee (Taxa Local)", icon: "fas fa-info-circle", content: info.resortFee },
        { title: "Estacionamento do Hotel", icon: "fas fa-car", content: info.parking }
      ];
      items.forEach(item => {
        const block = document.createElement("div");
        block.className = "info-block";
        block.innerHTML = `
          <h3><i class="${item.icon}" style="margin-right: 8px;"></i> ${item.title}</h3>
          <p>${item.content}</p>
        `;
        container.appendChild(block);
      });
    }

    // 13. Inicializa o mapa e as atrações
    function initMapAndAttractions(lat, lng, attractions) {
      const map = L.map("map").setView([lat, lng], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
      const hotelIcon = L.icon({
        iconUrl: "https://produtos.magictraveltur.com/wp-content/uploads/2024/10/Hotel-icon.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -30]
      });
      const marker = L.marker([lat, lng], { icon: hotelIcon }).addTo(map);
      marker.bindPopup(`<b>${document.getElementById("hotelName").textContent}</b>`);
      const container = document.getElementById("attractions");
      container.innerHTML = "<h2>Atrações</h2>";
      if (Array.isArray(attractions) && attractions.length) {
        attractions.forEach(a => {
          const latA = a.latitude || lat;
          const lngA = a.longitude || lng;
          const attrMarker = L.marker([latA, lngA]).addTo(map);
          attrMarker.bindPopup(`<b>${a.poiName || a.name}</b> - ${a.distance}`);
          container.innerHTML += `
            <div class="attraction-item">
              <i class="fas fa-map-marker-alt"></i> ${a.poiName || a.name} - ${a.distance}
            </div>
          `;
        });
      }
    }

    // 14. Inicializa o Flatpickr para seleção de datas
    function initDateRangePicker() {
      if (typeof flatpickr !== 'function') {
        console.error("Flatpickr não está disponível! Verifique se a biblioteca foi carregada.");
        return;
      }
      flatpickr("#checkin-checkout", {
        mode: "range",
        dateFormat: "d/m/Y",
        rangeSeparator: " - ",
        onClose: function(selectedDates) {
          if (selectedDates.length === 2) {
            const diff = Math.round((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
            document.getElementById("num-noites").textContent = diff > 0 ? diff : 1;
          }
        }
      });
    }

    // 15. Atualiza a busca e refaz a pesquisa ao clicar em "Pesquisar"
    window.updateRoomList = async function() {
      const dateRange = document.getElementById("checkin-checkout").value;
      if (dateRange.includes(" - ")) {
        const [startStr, endStr] = dateRange.split(" - ");
        const diff = moment(endStr, "DD/MM/YYYY").diff(moment(startStr, "DD/MM/YYYY"), "days");
        document.getElementById("num-noites").textContent = diff > 0 ? diff : 1;
      }
      const data = await fetchHotelCombined();
      if (data && data.combined && data.combined.length > 0) {
        const dollarRate = await getDollarRate();
        window.latestDollarRate = dollarRate;
        window.latestNumNoites = parseInt(document.getElementById("num-noites").textContent) || 1;
        loadHotelContent(data.combined[0], dollarRate);
      } else {
        console.error("Nenhum resultado para a pesquisa!");
      }
    };

    // 16. Seleciona o quarto e envia os dados para o carrinho com o preço final, checkin e checkout
    window.handleSelectRoom = function(hCode, hName, rCode, rName, finalPrice, basePriceChild) {
      let checkInDate = "", checkOutDate = "";
      const fpInstance = document.getElementById("checkin-checkout")._flatpickr;
      if (fpInstance && fpInstance.selectedDates.length === 2) {
        checkInDate = moment(fpInstance.selectedDates[0]).format("YYYY-MM-DD");
        checkOutDate = moment(fpInstance.selectedDates[1]).format("YYYY-MM-DD");
      } else {
        const dateRange = document.getElementById("checkin-checkout").value;
        if (dateRange.includes(" - ")) {
          const [startStr, endStr] = dateRange.split(" - ");
          checkInDate = moment(startStr, "DD/MM/YYYY").format("YYYY-MM-DD");
          checkOutDate = moment(endStr, "DD/MM/YYYY").format("YYYY-MM-DD");
        }
      }
      
      const numAdults = parseInt(document.getElementById("adults").value, 10) || 1;
      const numChildren = parseInt(document.getElementById("children").value, 10) || 0;
      const numRooms = parseInt(document.getElementById("rooms").value, 10) || 1;
      
      const selectedRoom = {
        type: "HOSPEDAGEM",
        hotelCode: hCode,
        hotelName: hName,
        roomCode: rCode,
        roomName: rName,
        rooms: numRooms,
        adults: numAdults,
        children: numChildren,
        checkIn: checkInDate,
        checkOut: checkOutDate,
        basePriceAdult: parseFloat(finalPrice),
        basePriceChild: parseFloat(basePriceChild) || 60
      };
    
      const cartComponent = document.querySelector("shopping-cart");
      if (cartComponent && typeof cartComponent.addItem === "function") {
        cartComponent.addItem(selectedRoom);
        cartComponent.openCart();
      } else {
        console.warn("O método addItem() não está implementado no componente!");
      }
    };

    // 17. Inicialização ao carregar a página
    document.addEventListener("DOMContentLoaded", async function() {
      initDateRangePicker();
      const query = getQueryParams();
      if (query.checkIn && query.checkOut) {
        const input = document.getElementById("checkin-checkout");
        input.value =
          moment(query.checkIn, "YYYY-MM-DD").format("DD/MM/YYYY") + " - " +
          moment(query.checkOut, "YYYY-MM-DD").format("DD/MM/YYYY");
        const d1 = moment(query.checkIn, "YYYY-MM-DD");
        const d2 = moment(query.checkOut, "YYYY-MM-DD");
        const diff = d2.diff(d1, "days");
        document.getElementById("num-noites").textContent = diff > 0 ? diff : 1;
      }
      if (query.rooms) document.getElementById("rooms").value = query.rooms;
      if (query.adults) document.getElementById("adults").value = query.adults;
      if (query.children) document.getElementById("children").value = query.children;
    
      const data = await fetchHotelCombined();
      if (data && data.combined && data.combined.length > 0) {
        const dollarRate = await getDollarRate();
        window.latestDollarRate = dollarRate;
        window.latestNumNoites = parseInt(document.getElementById("num-noites").textContent) || 1;
        loadHotelContent(data.combined[0], dollarRate);
      } else {
        console.error("Nenhum resultado inicial encontrado!");
      }
    });
  })();
  </script>
</body>
</html>

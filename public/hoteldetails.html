<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detalhes do Hotel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Font Awesome, Bootstrap Daterangepicker, Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.1.0/daterangepicker.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Carrega seu facilitiesMap.js (caso exista) -->
  <script src="/js/facilitiesMap.js"></script>

  <style>
    /* RESET e estilos básicos */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background-color: #f0f2f5; color: #333; line-height: 1.6; }
    .main-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* Cabeçalho do Hotel */
    .hotel-header { margin-bottom: 20px; }
    .hotel-name { font-size: 2em; font-weight: bold; color: #333; }
    .hotel-address { display: flex; align-items: center; font-size: 1em; color: #666; margin-top: 10px; }
    .hotel-address i { color: #0071e3; margin-right: 10px; }
    .location-link { color: #0071e3; text-decoration: none; margin-left: 10px; font-weight: bold; cursor: pointer; }
    .location-link:hover { text-decoration: underline; color: #005bb5; }

    /* Galeria de Fotos */
    .photo-gallery { display: grid; grid-template-columns: 2fr 1fr 1fr; grid-template-rows: repeat(2, 200px); gap: 10px; margin-bottom: 20px; }
    .photo-gallery img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .photo-gallery .large-photo { grid-row: 1 / 3; }

    /* Comodidades */
    .facilities { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

    .facility { display: flex; align-items: center; justify-content: center; padding: 15px; background-color: #fff; border-radius: 10px; border: 1px solid #ddd; text-align: center; transition: box-shadow 0.3s; }
    .facility i { font-size: 1.5em; color: #0071e3; margin-right: 10px; }
    .facility:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

    /* Descrição e Destaques */
    .description-container { display: flex; gap: 20px; margin-top: 20px; }
    .description { flex: 2; padding: 20px; border-right: 1px solid #e0e0e0; }
    .highlights { flex: 1; padding: 20px; background-color: #e9f7fe; border-radius: 8px; border: 2px solid #007bff; }
    .highlights h2 { font-size: 1.8em; color: #007bff; margin-bottom: 10px; text-align: center; font-weight: bold; }
    .highlights h3 { margin: 15px 0; color: #343a40; }
    .highlight-list { list-style: none; padding: 0; margin-bottom: 20px; }
    .highlight-list li { margin-bottom: 8px; padding-left: 30px; position: relative; color: #555; font-size: 1.1em; }
    .highlight-list li i { position: absolute; left: 0; color: #007bff; font-size: 1.2em; }

    /* Search Bar */
    .search-bar-container { display: flex; align-items: center; gap: 15px; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
    .search-fields { display: flex; align-items: center; gap: 15px; flex: 1; }
    .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
    .input-group label { font-size: 12px; color: #555; margin-left: 5px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; color: #333; }
    .search-button { background-color: #0071e3; color: #fff; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; flex-shrink: 0; height: 56px; font-size: 16px; }
    .search-button:hover { background-color: #005bb5; }

    /* Tabela de Quartos */
    .room-table { width: 100%; margin-top: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
    .room-table-header { display: grid; grid-template-columns: 3fr 1fr 2fr 1fr; background-color: #e9efff; padding: 15px; font-weight: bold; color: #333; text-align: center; }
    .room-group-title { grid-column: 1 / 5; background-color: #f5f7ff; font-weight: 700; font-size: 1.1em; padding: 10px; border-bottom: 1px solid #ddd; }
    .room-table-row { display: grid; grid-template-columns: 3fr 1fr 2fr 1fr; padding: 15px; align-items: center; border-bottom: 1px solid #ddd; }
    .room-info { display: flex; gap: 15px; align-items: center; }
    .room-image { width: 150px; height: 100px; border-radius: 10px; object-fit: cover; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .room-details { display: flex; flex-direction: column; }
    .room-details h4 { margin-bottom: 10px; font-size: 1.2em; color: #0071e3; }
    .room-details p { margin: 5px 0; color: #666; }
    .room-price { font-size: 1.5em; font-weight: bold; color: #333; text-align: center; }
    .price-info { text-align: center; font-size: 0.8em; color: #666; }
    .discount-price { font-size: 0.8em; font-weight: bold; color: #0071e3; margin: 0; padding: 0; }
    .installment-price { font-size: 0.8em; color: #666; }
    .select-room-button { background-color: #0071e3; color: #fff; padding: 10px 20px; border-radius: 5px; text-align: center; cursor: pointer; transition: background-color 0.3s; font-size: 1em; border: none; }
    .select-room-button:hover { background-color: #005bb5; }

    /* Informações Adicionais */
    .info-container { margin-top: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; }
    .info-block { flex: 1; min-width: 230px; margin: 10px; padding: 20px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .info-block h3 { font-size: 1.2em; color: #0071e3; font-weight: 600; }
    .info-block p { font-size: 1em; color: #555; }

    /* Mapa e Atrações */
    .container { display: flex; width: 100%; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 10px; background-color: #fff; margin-top: 20px; }
    .attractions { width: 35%; padding: 15px; max-height: 400px; overflow-y: auto; background-color: #fff; border: 1px solid #f2f2f2; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-right: 20px; display: flex; flex-direction: column; }
    #map { height: 400px; width: 65%; }
    .attraction-item { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; transition: background-color 0.3s; font-size: 16px; width: 100%; }
    .attraction-item:hover { background-color: #e0f7fa; }
    .attraction-item i { margin-right: 10px; color: #007AFF; font-size: 20px; }
    h2 { text-align: center; color: #333; margin-bottom: 20px; }
    footer { text-align: center; margin-top: 20px; color: #666; }
  </style>
</head>
<body>

  <!-- Importa header.html -->
  <div id="header"></div>

  <div class="main-container" id="hotelDetail">
    <!-- Cabeçalho do Hotel -->
    <div class="hotel-header">
      <div class="hotel-name" id="hotelName"></div>
      <div class="hotel-address" id="hotelAddress"></div>
    </div>

    <!-- Galeria de Fotos -->
    <div class="photo-gallery" id="photoGallery"></div>

    <!-- Seção de Comodidades -->
    <section class="facilities" id="facilities"></section>

    <!-- Descrição e Destaques -->
    <div class="description-container">
      <div class="description" id="hotelDescription"></div>
      <div class="highlights" id="hotelHighlights"></div>
    </div>

    <!-- Barra de Busca -->
    <div class="search-bar-container" id="searchBar">
      <div class="search-fields">
        <div class="input-group">
          <label for="checkin-checkout">Datas</label>
          <input type="text" id="checkin-checkout" placeholder="Check-in - Check-out">
        </div>
        <div class="input-group">
          <label for="rooms">Quartos</label>
          <input type="number" id="rooms" placeholder="Nº de Quartos" min="1" max="10" value="1">
        </div>
        <div class="input-group">
          <label for="adults">Adultos (+18 Anos)</label>
          <input type="number" id="adults" placeholder="Nº de Adultos" min="1" max="10" value="1">
        </div>
        <div class="input-group">
          <label for="children">Crianças (0 a 17 anos)</label>
          <input type="number" id="children" placeholder="Nº de Crianças" min="0" max="10" value="0">
        </div>
      </div>
      <button class="search-button" onclick="updateRoomList()">Pesquisar</button>
    </div>

    <!-- Tabela de Quartos -->
    <section class="room-table" id="roomTable">
      <div class="room-table-header">
        <div>Tipo de Quarto</div>
        <div>Hóspedes</div>
        <div>Preço para <span id="num-noites">0</span> Noites</div>
        <div></div>
      </div>
      <div class="room-table-body" id="roomTableBody"></div>
    </section>

    <!-- Informações adicionais -->
    <div class="info-container" id="infoContainer"></div>

    <!-- Mapa e Atrações -->
    <div class="container" id="mapAttractionsContainer">
      <div class="attractions" id="attractions">
        <h2>Atrações</h2>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.1.0/daterangepicker.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  // URL base para as imagens do Hotelbeds
  const BASE_IMG_URL = "https://photos.hotelbeds.com/giata/xl/";

  /***********************************************
  * A) IMPORTA O HEADER
  ***********************************************/
  fetch("header.html")
    .then(resp => resp.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;
    })
    .catch(err => console.error("Erro ao carregar header:", err));

  /***********************************************
  * B) EVENTO PARA ROLAR ATÉ O MAPA AO CLICAR EM "VER MAPA"
  ***********************************************/
  document.addEventListener("click", function(e) {
    const link = e.target.closest(".location-link");
    if (link) {
      e.preventDefault();
      const mapSection = document.getElementById("mapAttractionsContainer");
      if (mapSection) {
        mapSection.scrollIntoView({ behavior: "smooth" });
      }
    }
  });

  /***********************************************
  * C) UTILITÁRIOS – LEITURA DA QUERY STRING
  ***********************************************/
  function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    const query = {};
    for (const [key, value] of params.entries()) {
      query[key] = value;
    }
    return query;
  }

  function getHotelIdFromUrl() {
    const query = getQueryParams();
    return query.id;
  }

  function toISO(dmy) {
    // Converte "DD/MM/YYYY" para "YYYY-MM-DD"
    const [d, m, y] = dmy.split('/');
    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
  }

  /***********************************************
  * D) BUSCA DOS DADOS DO HOTEL – CONTENT API (GET)
  ***********************************************/
  function fetchHotelContentById(hotelId) {
    const url = `/api/hotelbeds/hotel-content?hotelCode=${hotelId}`;
    return fetch(url, { method: "GET" })
      .then(resp => resp.json())
      .then(json => json.hotel || null);
  }

  /***********************************************
  * E) BUSCA DOS DADOS DO HOTEL – BOOKING API (POST)
  * Chamado para obter disponibilidade e informações dos quartos.
  * A rota no backend gera o payload:
  * {
  *    "stay": { "checkIn": "...", "checkOut": "..." },
  *    "occupancies": [ { "rooms": 1, "adults": 2, "children": 0 } ],
  *    "page":1, "limit":20
  * }
  * Após a resposta, filtramos para obter somente o hotel com o código desejado.
  ***********************************************/
  async function fetchHotelBookingData(query) {
    // Usa os parâmetros da query para construir a chamada
    const { checkIn, checkOut, destination = "MCO", rooms = "1", adults = "1", children = "0", id } = query;
    // Converte datas para ISO
    const isoCheckIn = toISO(checkIn);
    const isoCheckOut = toISO(checkOut);
    // Monta os parâmetros para os quartos
    // Supondo apenas 1 quarto (pois a query já traz "rooms" que indica a quantidade)
    let queryString = `?checkIn=${isoCheckIn}&checkOut=${isoCheckOut}&destination=${destination}&rooms=${rooms}&page=1&limit=20`;
    // Adiciona os parâmetros dos ocupancies (supondo 1 quarto)
    queryString += `&adults1=${adults}&children1=${children}`;

    try {
      const resp = await fetch(`/api/hotelbeds/hotels${queryString}`, { method: "GET" });
      if (!resp.ok) {
        throw new Error(`Booking API Error: ${resp.status}`);
      }
      const bookingData = await resp.json();
      // bookingData.hotels.hotels é o array de hotéis retornados
      const hotelsArr = bookingData.hotels?.hotels || [];
      // Filtra para o hotel com código igual a id
      const bookingHotel = hotelsArr.find(h => h.code == id);
      if (!bookingHotel) {
        console.error("Hotel não encontrado na resposta do Booking API.");
      }
      return bookingHotel;
    } catch (err) {
      console.error("Erro ao buscar dados na Booking API:", err);
      return null;
    }
  }

  /***********************************************
  * F) CARREGA OS DADOS NO TEMPLATE
  * Combina os dados do CONTENT e BOOKING API.
  ***********************************************/
  function loadHotelContent(content) {
    if (!content) return;
    // Cabeçalho – Nome e Endereço
    const hotelName = content.name?.content || "Hotel sem nome";
    const addressStreet = content.address?.street || "";
    const addressCity   = content.city?.content || "";
    const addressCountry = content.country?.description?.content || "";
    const fullAddress = addressStreet + (addressCity ? `, ${addressCity}` : "") + (addressCountry ? ` - ${addressCountry}` : "");
    document.getElementById("hotelName").textContent = hotelName;
    document.getElementById("hotelAddress").innerHTML =
      `<i class="fas fa-map-marker-alt"></i> ${fullAddress} <a href="#" class="location-link">Ver mapa</a>`;

    // Galeria de fotos – filtra imagens com type.code === "GEN"
    const genImages = (content.images || [])
      .filter(img => img.type.code === "GEN")
      .map(img => BASE_IMG_URL + img.path);
    fillPhotoGallery(genImages);

    // Facilidades – lista até 12 itens
    const facList = (content.facilities || []).map(f => f.description?.content || "");
    fillFacilities(facList.slice(0, 12));

    // Descrição
    if (content.description?.content) {
      document.getElementById("hotelDescription").innerHTML = content.description.content;
    }

    // Destaques – exemplo fixo (ou se houver, pode ser substituído)
    document.getElementById("hotelHighlights").innerHTML =
      `<h2>Destaques da Acomodação</h2><p>Confira as melhores vantagens desta acomodação.</p>`;

    // Mapa e Atrações
    const lat = content.coordinates?.latitude || 0;
    const lng = content.coordinates?.longitude || 0;
    initMapAndAttractions(lat, lng, content.interestPoints);
    
    // Inicializa o Date Range Picker
    initDateRangePicker();
  }

  // Função para atualizar a tabela de quartos usando os dados do BOOKING API
  function createRoomTableFromBooking(roomsData) {
    const tableBody = document.getElementById("roomTableBody");
    tableBody.innerHTML = "";
    if (!roomsData || !roomsData.length) return;

    // Agrupa os quartos por nome (exibindo somente o name, não o code)
    const groups = {};
    roomsData.forEach(room => {
      const groupName = room.name || "Outros";
      if (!groups[groupName]) groups[groupName] = [];
      groups[groupName].push(room);
    });

    for (const groupName in groups) {
      // Título do grupo
      const groupRow = document.createElement("div");
      groupRow.className = "room-group-title";
      groupRow.textContent = groupName;
      tableBody.appendChild(groupRow);

      groups[groupName].forEach(room => {
        const row = document.createElement("div");
        row.className = "room-table-row";
        // Define número máximo de hóspedes – se disponível, ou padrão 2
        row.setAttribute("data-max-guests", room.maxPax || 2);

        // Como o Booking API geralmente não traz imagens, use uma imagem fallback
        const roomImg = room.image || "https://dummyimage.com/150x100/ccc/000.png&text=No+Image";
        // Preço – utiliza o primeiro rate.net
        let basePrice = 300;
        if (room.rates && room.rates.length) {
          basePrice = parseFloat(room.rates[0].net) || basePrice;
        }
        // Detalhes do quarto – se houver rates com boardName ou similar
        const details = room.rates && room.rates.length
          ? [`Board: ${room.rates[0].boardName || "N/A"}`]
          : [];

        row.innerHTML = `
          <div class="room-info">
            <img src="${roomImg}" alt="${room.name}" class="room-image">
            <div class="room-details">
              <h4>${room.name}</h4>
              ${details.map(d => `<p><i class="fas fa-check"></i> ${d}</p>`).join("")}
            </div>
          </div>
          <div class="room-guests">${room.maxPax || 2} Hóspedes</div>
          <div class="room-price" data-price="${basePrice}">
            <p class="discount-price">R$ <span class="pix-price">${basePrice.toFixed(2)}</span><br>
            <span style="font-size: 0.8em; color: green;">Super desconto no Pix</span></p>
            <div class="price-info">
              <p>ou R$ <span class="installment-price">${(basePrice / 10).toFixed(2)}</span> em até 10x sem juros</p>
              <div class="daily-price-container">
                <p style="font-weight: normal;">Preço por diária: R$ <span>${basePrice.toFixed(2)}</span></p>
              </div>
            </div>
          </div>
          <div>
            <button class="select-room-button" onclick="handleSelectRoom('${room.code}')">Selecionar Quarto</button>
          </div>
        `;
        tableBody.appendChild(row);
      });
    }
  }

  /***********************************************
  * F) FUNÇÕES DE RENDERIZAÇÃO AUXILIARES
  ***********************************************/
  // F1) Galeria de fotos
  function fillPhotoGallery(photos) {
    const gallery = document.getElementById("photoGallery");
    gallery.innerHTML = "";
    if (!photos || !photos.length) return;
    const largeImg = document.createElement("img");
    largeImg.src = photos[0];
    largeImg.alt = "Foto do Hotel";
    largeImg.classList.add("large-photo");
    gallery.appendChild(largeImg);
    for (let i = 1; i < photos.length && i < 5; i++) {
      const img = document.createElement("img");
      img.src = photos[i];
      img.alt = "Foto do Hotel";
      gallery.appendChild(img);
    }
  }

  // F2) Facilidades
  function fillFacilities(facilities) {
    const container = document.getElementById("facilities");
    container.innerHTML = "";
    if (!facilities || !facilities.length) return;
    facilities.forEach(f => {
      container.innerHTML += `<div class="facility"><i class="fas fa-check"></i> ${f}</div>`;
    });
  }

  // F3) Informações adicionais
  function fillInfoBlocks(info) {
    const container = document.getElementById("infoContainer");
    container.innerHTML = "";
    if (!info) return;
    const items = [
      { title: "Horário de Check-in (Entrada)", icon: "fas fa-clock", content: info.checkin },
      { title: "Horário de Check-out (Saída)", icon: "fas fa-clock", content: info.checkout },
      { title: "Resort Fee (Taxa Local)", icon: "fas fa-info-circle", content: info.resortFee },
      { title: "Estacionamento do Hotel", icon: "fas fa-car", content: info.parking }
    ];
    items.forEach(item => {
      const block = document.createElement("div");
      block.className = "info-block";
      block.innerHTML = `
        <h3><i class="${item.icon}" style="margin-right: 8px;"></i> ${item.title}</h3>
        <p>${item.content}</p>
      `;
      container.appendChild(block);
    });
  }

  // F4) Mapa e Atrações
  function initMapAndAttractions(lat, lng, attractions) {
    const map = L.map("map").setView([lat, lng], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const hotelIcon = L.icon({
      iconUrl: "https://produtos.magictraveltur.com/wp-content/uploads/2024/10/Hotel-icon.png",
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -30]
    });
    const marker = L.marker([lat, lng], { icon: hotelIcon }).addTo(map);
    marker.bindPopup(`<b>${document.getElementById("hotelName").textContent}</b>`);

    fillAttractions(attractions);
    if (Array.isArray(attractions)) {
      attractions.forEach(a => {
        const latA = a.latitude || lat;
        const lngA = a.longitude || lng;
        const attrMarker = L.marker([latA, lngA]).addTo(map);
        attrMarker.bindPopup(`<b>${a.poiName || a.name}</b> - ${a.distance}`);
      });
    }
  }

  function fillAttractions(attractions) {
    const container = document.getElementById("attractions");
    container.innerHTML = "<h2>Atrações</h2>";
    if (!attractions || !attractions.length) return;
    attractions.forEach(a => {
      container.innerHTML += `
        <div class="attraction-item">
          <i class="fas fa-map-marker-alt"></i> ${a.poiName || a.name} - ${a.distance}
        </div>
      `;
    });
  }

  /***********************************************
  * G) ATUALIZA A TABELA DE QUARTOS COM BASE NOS DADOS DE BUSCA (BOOKING API)
  ***********************************************/
  window.updateRoomList = function() {
    // Atualiza as linhas da tabela de quartos com base nos dados atuais da busca
    const numNoites = parseInt(document.getElementById("num-noites").textContent) || 1;
    const numRooms = parseInt(document.getElementById("rooms").value) || 1;
    const numAdults = parseInt(document.getElementById("adults").value) || 1;
    const numChildren = parseInt(document.getElementById("children").value) || 0;
    const totalGuests = numAdults + numChildren;

    document.querySelectorAll(".room-table-row").forEach(row => {
      const maxGuests = parseInt(row.getAttribute("data-max-guests")) || 2;
      const priceEl = row.querySelector(".room-price");
      const basePrice = parseFloat(priceEl.getAttribute("data-price")) || 300;
      if (totalGuests > maxGuests) {
        row.style.display = "none";
      } else {
        row.style.display = "grid";
        const totalPrice = (numNoites * basePrice) * numRooms;
        const dailyRate = numNoites > 0 ? (totalPrice / numNoites).toFixed(2) : "Clique em pesquisar";
        priceEl.innerHTML = `
          <p class="discount-price">R$ <span class="pix-price">${totalPrice.toFixed(2)}</span><br>
          <span style="font-size: 0.8em; color: green;">Super desconto no Pix</span></p>
          <div class="price-info">
            <p>ou R$ <span class="installment-price">${(totalPrice / 10).toFixed(2)}</span> em até 10x sem juros</p>
            <div class="daily-price-container">
              <p style="font-weight: normal;">Preço por diária: R$ <span>${dailyRate}</span></p>
            </div>
          </div>
        `;
      }
    });
  };

  /***********************************************
  * H) INICIALIZA O DATE RANGE PICKER
  ***********************************************/
  function initDateRangePicker() {
    $("#checkin-checkout").daterangepicker({
      locale: {
        format: "DD/MM/YYYY",
        daysOfWeek: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"],
        monthNames: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
      },
      opens: "center",
      drops: "down",
      autoApply: false,
      autoUpdateInput: false
    }, function(start, end) {
      const diffDays = end.diff(start, "days");
      document.getElementById("num-noites").textContent = diffDays > 0 ? diffDays : 1;
      $("#checkin-checkout").val(start.format("DD/MM/YYYY") + " - " + end.format("DD/MM/YYYY"));
      updateRoomList();
    });
  }

  /***********************************************
  * I) EVENTO PARA "SELECIONAR QUARTO"
  ***********************************************/
  window.handleSelectRoom = function(roomCode) {
    // Lê os parâmetros atuais da query e dos inputs de busca
    const query = getQueryParams();
    const hotelId = query.id || "";
    const dateRange = document.getElementById("checkin-checkout").value || "";
    let checkIn = "", checkOut = "";
    if (dateRange) {
      const dates = dateRange.split(" - ");
      checkIn = dates[0] || "";
      checkOut = dates[1] || "";
    }
    const rooms = document.getElementById("rooms").value || "1";
    const adults = document.getElementById("adults").value || "1";
    const children = document.getElementById("children").value || "0";

    const params = new URLSearchParams({
      id: hotelId,
      checkIn: checkIn,
      checkOut: checkOut,
      rooms: rooms,
      adults: adults,
      children: children,
      roomCode: roomCode
    }).toString();

    window.location.href = "confirmation.html?" + params;
  };

  /***********************************************
  * J) BUSCA DOS DADOS DO BOOKING API (para quartos) – USANDO OS PARÂMETROS DA QUERY
  ***********************************************/
  async function fetchHotelBookingData(query) {
    const { checkIn, checkOut, destination = "MCO", rooms = "1", adults = "1", children = "0", id } = query;
    if (!checkIn || !checkOut) {
      console.error("Datas de check-in e check-out são necessárias.");
      return null;
    }
    const isoCheckIn = toISO(checkIn);
    const isoCheckOut = toISO(checkOut);
    let qs = `?checkIn=${isoCheckIn}&checkOut=${isoCheckOut}&destination=${destination}&rooms=${rooms}&page=1&limit=20`;
    qs += `&adults1=${adults}&children1=${children}`;

    try {
      const resp = await fetch(`/api/hotelbeds/hotels${qs}`, { method: "GET" });
      if (!resp.ok) {
        throw new Error(`Booking API Error: ${resp.status}`);
      }
      const data = await resp.json();
      const hotelsArr = data.hotels?.hotels || [];
      const bookingHotel = hotelsArr.find(h => h.code == id);
      if (!bookingHotel) {
        console.error("Hotel não encontrado na resposta da Booking API.");
      }
      return bookingHotel;
    } catch (err) {
      console.error("Erro ao buscar dados da Booking API:", err);
      return null;
    }
  }

  /***********************************************
  * K) INICIALIZA A PÁGINA
  ***********************************************/
  document.addEventListener("DOMContentLoaded", async function() {
    // Pré-preenche a barra de busca com os dados da query, se houver
    const query = getQueryParams();
    if (query.checkIn && query.checkOut) {
      const input = document.getElementById("checkin-checkout");
      input.value = query.checkIn + " - " + query.checkOut;
      if (typeof moment !== "undefined") {
        const d1 = moment(query.checkIn, "DD/MM/YYYY");
        const d2 = moment(query.checkOut, "DD/MM/YYYY");
        const diff = d2.diff(d1, "days");
        document.getElementById("num-noites").textContent = diff > 0 ? diff : 1;
      }
    }
    if (query.rooms)    document.getElementById("rooms").value = query.rooms;
    if (query.adults)   document.getElementById("adults").value = query.adults;
    if (query.children) document.getElementById("children").value = query.children;

    const hotelId = query.id;
    if (!hotelId) {
      console.error("Nenhum hotel id fornecido na URL!");
      return;
    }

    // Busca os dados do hotel via CONTENT API
    const contentData = await fetchHotelContentById(hotelId);
    if (contentData) {
      loadHotelContent(contentData);
    } else {
      console.error("Conteúdo não encontrado para o ID:", hotelId);
    }

    // Busca os dados do hotel via BOOKING API para quartos
    const bookingHotel = await fetchHotelBookingData(query);
    if (bookingHotel && bookingHotel.rooms) {
      createRoomTableFromBooking(bookingHotel.rooms);
    } else {
      console.error("Dados de quartos não encontrados na Booking API para o hotel:", hotelId);
    }
  });
</script>
</body>
</html>

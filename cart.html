<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Carrinho Suspenso - √çcones Inline SVG + padStart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* RESET / BASE */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
    }

    /* CARRINHO FIXO NA DIREITA */
    .cart-container {
      position: fixed;
      top: 0; 
      right: 0;
      width: 380px;
      height: 100vh;
      background: #fff;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }
    /* HEADER DO CARRINHO */
    .cart-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-header h2 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .timer-info {
      font-size: 0.75rem;
      color: #2a942f;
      background: #ebfaeb;
      border: 1px solid #c8eac7;
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
    }

    /* CORPO DO CARRINHO */
    .cart-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #fafafa;
    }
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #444;
    }

    /* CARD DO ITEM */
    .cart-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .cart-item:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    /* √çcone de lixeira */
    .trash-btn {
      position: absolute;
      top: 10px; 
      right: 10px;
      background: none;
      border: none;
      font-size: 1rem;
      color: #999;
      cursor: pointer;
      transition: color 0.2s;
    }
    .trash-btn:hover {
      color: #e00;
    }

    /* Tag ‚ÄúINGRESSOS‚Äù */
    .tag-ingresso {
      display: inline-block;
      background: #ffefcc;
      color: #ff9900;
      border: 1px solid #ffd899;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 12px;
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }
    .item-title {
      font-weight: 600;
      margin: 0.2rem 0;
      color: #333;
      font-size: 0.9rem;
    }

    /* DATA COM √çCONE (inline SVG) */
    .item-date {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #666;
      margin: 0.4rem 0;
    }
    .calendar-icon {
      width: 16px;
      height: 16px;
      fill: #666;
      vertical-align: middle;
    }

    /* CRIAN√áAS E ADULTOS, DIVIS√ìRIA, √çCONES, BOTOES +/‚Äì */
    .item-quantities {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.4rem;
      position: relative;
    }
    .quantities-left {
      display: flex;
      gap: 20px;
    }
    .quant-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .quant-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      text-transform: capitalize;
    }
    .quant-label .icon {
      width: 16px;
      height: 16px;
      fill: #666;
    }
    .plusminus-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .plusminus-btn {
      width: 24px;
      height: 24px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.2s;
    }
    .plusminus-btn:hover {
      background: #f2f2f2;
    }
    .divider {
      border-left: 1px solid #ccc;
      height: 40px;
      margin-top: 8px;
    }

    /* PRE√áO NO CANTO INFERIOR DIREITO + ‚Äúat√© 10x sem juros‚Äù em azul */
    .item-price {
      position: absolute;
      right: 1rem;
      bottom: 1rem;
      font-weight: 600;
      font-size: 0.85rem;
      color: #333;
      text-align: right;
    }
    .installment-info {
      font-size: 0.7rem;
      color: #007bff; /* azul */
      margin-top: 2px;
    }

    /* SUBTOTAL, DESCONTO, TOTAL */
    .price-line {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }
    .price-line .green {
      color: #2a942f;
      font-weight: 600;
    }
    .total-line {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin: 0.5rem 0 1rem;
    }
    .checkout-btn {
      width: 100%;
      background: #35b473;
      border: none;
      color: #fff;
      font-size: 0.9rem;
      border-radius: 6px;
      padding: 0.7rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkout-btn:hover {
      background: #2d9e64;
    }

    /* RODAP√â DO CARRINHO */
    .cart-footer {
      border-top: 1px solid #eee;
      padding: 1rem;
      background: #fff;
    }
    .footer-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .footer-actions input {
      flex: 1;
      min-width: 0;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .footer-actions .btn-mini {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .footer-actions .btn-mini:hover {
      background: #005bb5;
    }
    .footer-actions .btn-mini-danger {
      background: #d93025;
    }
    .footer-actions .btn-mini-danger:hover {
      background: #b0241a;
    }
  </style>
</head>
<body>

<div class="cart-container">
  <!-- HEADER DO CARRINHO -->
  <div class="cart-header">
    <h2>Resumo do pedido</h2>
    <span class="timer-info" id="timerValue">01:02</span>
  </div>

  <!-- CORPO DO CARRINHO -->
  <div class="cart-body">
    <div class="section-title">Ingressos</div>

    <!-- CARD DO ITEM -->
    <div class="cart-item">
      <button class="trash-btn" onclick="removeItem()">üóë</button>
      <span class="tag-ingresso">INGRESSOS</span>
      <div class="item-title">WALT DISNEY WORLD - INGRESSO 1 DIA MAGIC KINGDOM [1 dia]</div>

      <!-- Data com √≠cone (inline SVG) -->
      <div class="item-date">
        <svg class="calendar-icon" viewBox="0 0 16 16">
          <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 
1 0V1h.5A1.5 1.5 0 0 1 15 
2.5v11A1.5 1.5 0 0 1 13.5 
15h-11A1.5 1.5 0 0 1 1 
13.5v-11A1.5 1.5 0 0 1 
2.5 1H3V.5a.5.5 0 0 
1 .5-.5zM2.5 2a.5.5 
0 0 0-.5.5V4h12V2.5a.5.5 
0 0 0-.5-.5h-11zM14 5H2v8.5a.5.5 
0 0 0 .5.5h11a.5.5 0 0 
0 .5-.5V5z"/>
        </svg>
        <span id="dateVal">2025-04-12</span>
      </div>

      <!-- Crian√ßas e Adultos, cada um com √≠cone e nome, divis√≥ria, +/‚Äì horizontal -->
      <div class="item-quantities">
        <div class="quantities-left">
          <!-- Crian√ßas -->
          <div class="quant-column">
            <div class="quant-label">
              <svg class="icon" viewBox="0 0 16 16">
                <!-- √çcone "baby" (ou outro) substitu√≠do -->
                <path d="M8 1a3 3 0 0 1 2.995 
2.824l.16.012c.58.06 1.174.37 
1.512.865.342.504.334 1.185.18 
2.122-.132.778-.477 1.69-.868 
2.442-.46.865-.989 1.464-1.454 
1.699v.536c0 .582-.4 1.067-.964 
1.159v.181c0 
.28-.224.506-.5.506s-.5-.226-.5-.506v-.182c-.564-.091-.964-.577-.964-1.158v-.537c-.465-.235-.993-.834-1.454-1.699-.391-.752-.736-1.664-.868-2.442-.154-.937-.162-1.618.18-2.122.338-.495.932-.805 1.512-.865l.16-.012A3 3 0 0 1 8 1z"/>
              </svg>
              <span>Crian√ßas</span>
            </div>
            <div class="plusminus-row">
              <button class="plusminus-btn" onclick="decChildren()">-</button>
              <span id="childCount">00</span>
              <button class="plusminus-btn" onclick="incChildren()">+</button>
            </div>
          </div>

          <!-- Divis√≥ria vertical -->
          <div class="divider"></div>

          <!-- Adultos -->
          <div class="quant-column">
            <div class="quant-label">
              <svg class="icon" viewBox="0 0 16 16">
                <!-- √çcone "person" (adult) -->
                <path d="M8 4a2 2 0 1 0 0 4 
2 2 0 0 0 0-4zM4 
8a4 4 0 1 1 8 0A4 4 0 0 
1 4 8zm-2 
6c0-1.346.418-2.61 1.126-3.634C4.04 
9.434 5.469 9 8 9s3.96.434 
4.874 1.366A5.986 5.986 0 0 1 
14 14H2z"/>
              </svg>
              <span>Adultos</span>
            </div>
            <div class="plusminus-row">
              <button class="plusminus-btn" onclick="decAdults()">-</button>
              <span id="adultCount">01</span>
              <button class="plusminus-btn" onclick="incAdults()">+</button>
            </div>
          </div>
        </div>

        <!-- PRE√áO no canto inferior direito + ‚Äúat√© 10x sem juros‚Äù em azul -->
        <div class="item-price" id="priceVal">
          R$ 160,00
          <div class="installment-info">at√© 10x sem juros</div>
        </div>
      </div>
    </div>

    <!-- Subtotal, desconto, total -->
    <div class="price-line">
      <span>Subtotal</span>
      <span id="subtotalValue">R$ 160,00</span>
    </div>
    <div class="price-line">
      <span>Desconto</span>
      <span class="green" id="discountValue">- R$ 0,00</span>
    </div>
    <div class="total-line">
      <span>Total do pedido</span>
      <span id="totalValue">R$ 160,00</span>
    </div>
    <button class="checkout-btn">Ir para o checkout</button>
  </div>

  <!-- RODAP√â -->
  <div class="cart-footer">
    <div class="footer-actions">
      <input type="text" id="affiliateId" value="aff123" placeholder="Affiliate">
      <input type="text" id="agentId" value="agt567" placeholder="Agent">
    </div>
    <div class="footer-actions">
      <button class="btn-mini" onclick="shareCart()">Compartilhar</button>
      <button class="btn-mini btn-mini-danger" onclick="clearCartServer()">Limpar</button>
    </div>
  </div>
</div>

<script>
  /*
    C√ìDIGO COMPLETO:
    - shareCart => POST /shareCart
    - updateCartServer => POST /updateCart
    - loadCartFromServer => GET /cart/:shareId
    - clearCartServer => POST /clearCart
    - L√™/Escreve shareId no localStorage
    - 1 item local
    - Exibe quantidades com padStart(2,'0')
  */
  const BASE_URL = "http://localhost:3000"; // Ajuste p/ seu backend Node
  let shareId = null;

  // √önico item
  let item = {
    children: 0,
    adults: 1,
    date: "2025-04-12",
    basePriceAdult: 80,
    basePriceChild: 60
  };

  // Ao carregar, checa shareId no localStorage e ?shareId
  window.onload = () => {
    const stored = localStorage.getItem("shareId");
    if(stored){
      shareId = stored;
      loadCartFromServer(shareId);
    }
    const params = new URLSearchParams(window.location.search);
    const paramS = params.get("shareId");
    if(paramS){
      shareId = paramS;
      localStorage.setItem("shareId", shareId);
      loadCartFromServer(shareId);
    }
    renderItem();
  };

  // Render local
  function renderItem(){
    // Exibe quantidades como "01", "02", etc
    const childStr = item.children.toString().padStart(2, '0');
    const adultStr = item.adults.toString().padStart(2, '0');

    document.getElementById("childCount").textContent = childStr;
    document.getElementById("adultCount").textContent = adultStr;

    const totalItem = (item.adults * item.basePriceAdult) + (item.children * item.basePriceChild);
    // Exibe pre√ßo e "at√© 10x sem juros" em azul
    document.getElementById("priceVal").innerHTML =
      `R$ ${totalItem.toLocaleString('pt-BR',{minimumFractionDigits:2})}
       <div class="installment-info">at√© 10x sem juros</div>`;

    // Subtotal, desconto=0, total= totalItem
    document.getElementById("subtotalValue").textContent =
      "R$ " + totalItem.toLocaleString('pt-BR',{minimumFractionDigits:2});
    document.getElementById("discountValue").textContent = "- R$ 0,00";
    document.getElementById("totalValue").textContent =
      "R$ " + totalItem.toLocaleString('pt-BR',{minimumFractionDigits:2});
  }

  // +/-
  function incChildren(){
    item.children++;
    renderItem();
    updateCartServer();
  }
  function decChildren(){
    if(item.children>0) item.children--;
    renderItem();
    updateCartServer();
  }
  function incAdults(){
    item.adults++;
    renderItem();
    updateCartServer();
  }
  function decAdults(){
    if(item.adults>0) item.adults--;
    renderItem();
    updateCartServer();
  }

  // Remover item
  function removeItem(){
    item.children=0;
    item.adults=0;
    renderItem();
    updateCartServer();
    alert("Item removido");
  }

  // shareCart => se shareId n√£o existe => POST /shareCart
  async function shareCart(){
    if(item.adults===0 && item.children===0){
      alert("Item vazio, nada a compartilhar!");
      return;
    }
    if(shareId){
      alert("Carrinho j√° possui shareId: "+shareId);
      return;
    }
    const affiliateId = document.getElementById("affiliateId").value.trim();
    const agentId = document.getElementById("agentId").value.trim();
    if(!affiliateId || !agentId){
      alert("Informe affiliateId e agentId!");
      return;
    }
    // Mandamos array c/ 1 item sem pre√ßo
    const items = [{
      type: "INGRESSOS",
      category: "WALT DISNEY WORLD",
      nameDays: "INGRESSO 1 DIA MAGIC KINGDOM [1 dia]",
      date: item.date,
      adults: item.adults,
      children: item.children
    }];
    try {
      const resp = await fetch(`${BASE_URL}/shareCart`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ affiliateId, agentId, items })
      });
      const data = await resp.json();
      if(data.success){
        shareId = data.shareId;
        localStorage.setItem("shareId", shareId);
        const link = window.location.origin + window.location.pathname + "?shareId="+shareId;
        alert("Carrinho compartilhado!\n"+link);
      } else {
        alert("Erro ao compartilhar: "+(data.error||"desconhecido"));
      }
    } catch(e){
      console.error(e);
      alert("Falha ao compartilhar carrinho!");
    }
  }

  // updateCart => se shareId => POST /updateCart
  async function updateCartServer(){
    if(!shareId) return;
    const items = [{
      type: "INGRESSOS",
      category: "WALT DISNEY WORLD",
      nameDays: "INGRESSO 1 DIA MAGIC KINGDOM [1 dia]",
      date: item.date,
      adults: item.adults,
      children: item.children
    }];
    try {
      const resp = await fetch(`${BASE_URL}/updateCart`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ shareId, items })
      });
      const data = await resp.json();
      if(!data.success){
        console.error("Erro updateCart:", data.error);
      }
    } catch(e){
      console.error(e);
    }
  }

  // loadCartFromServer => GET /cart/:shareId
  async function loadCartFromServer(sId){
    try {
      const resp = await fetch(`${BASE_URL}/cart/${sId}`);
      const data = await resp.json();
      if(!data.success){
        console.error("Erro loadCart:", data.error);
        return;
      }
      if(data.items.length>0){
        const i = data.items[0];
        item.adults = i.adults;
        item.children = i.children;
        item.date = i.date;
      }
      renderItem();
    } catch(e){
      console.error(e);
    }
  }

  // clearCartServer => se shareId => POST /clearCart
  async function clearCartServer(){
    if(!shareId){
      item.adults=0; 
      item.children=0;
      renderItem();
      alert("Carrinho local limpo!");
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/clearCart`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ shareId })
      });
      const data = await resp.json();
      if(data.success){
        alert("Carrinho removido do servidor!");
        item.adults=0; 
        item.children=0;
        renderItem();
        shareId=null;
        localStorage.removeItem("shareId");
      } else {
        alert("Erro ao limpar: "+(data.error||"desconhecido"));
      }
    } catch(e){
      console.error(e);
    }
  }
</script>
</body>
</html>

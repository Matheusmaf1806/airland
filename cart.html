<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Carrinho Suspenso - Exemplo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* Layout geral */
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    header {
      background: #333;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    main {
      padding: 20px;
    }

    /* Bot√£o que abre o carrinho */
    #openCartBtn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
    }
    #openCartBtn:hover {
      background: #005dc1;
    }

    /* Carrinho flutuante (suspenso) */
    #cartOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; /* oculto por padr√£o */
    }
    #cartPanel {
      position: fixed;
      top: 0; 
      right: 0;
      width: 350px;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    #cartPanel.open {
      transform: translateX(0);
    }
    #cartHeader {
      padding: 10px;
      background: #007bff;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #cartBody {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    #cartFooter {
      border-top: 1px solid #ddd;
      padding: 10px;
    }

    /* Cart items */
    .cart-item {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .remove-btn {
      position: absolute;
      top: 8px; 
      right: 8px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      color: #f00;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .row label {
      margin-right: 5px;
    }
    .quantity-box {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .quantity-box button {
      width: 30px; 
      height: 30px;
      cursor: pointer;
    }
    .btn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .btn:hover {
      background: #005dc1;
    }
    .danger {
      background: #dc3545;
    }
    .danger:hover {
      background: #a71d2a;
    }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }

    /* Exemplo de forms p/ affiliateId e agentId */
    .inline-form {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .inline-form label {
      font-weight: bold;
    }

  </style>
</head>
<body>

<header>
  <h1>Carrinho Suspenso (Sem Pre√ßo)</h1>
  <button id="openCartBtn">Meu Carrinho</button>
</header>

<main>
  <p>Adicione alguns itens de exemplo:</p>

  <!-- Form para adicionar um item -->
  <div style="margin-bottom:20px; background:#fff; padding:10px; border-radius:6px;">
    <h2>Novo Item</h2>
    <label>Type:</label>
    <input type="text" id="typeInput" value="Ingressos"><br><br>

    <label>Categoria:</label>
    <input type="text" id="categoryInput" value="Walt Disney World"><br><br>

    <label>Nome e Dias:</label>
    <input type="text" id="nameDaysInput" value="Base Tickets - 03 Dias"><br><br>

    <label>Adultos:</label>
    <input type="number" id="adultsInput" value="2" min="0" style="width:60px;">
    <label>Crian√ßas:</label>
    <input type="number" id="childrenInput" value="1" min="0" style="width:60px;"><br><br>

    <button class="btn" onclick="addItem()">Adicionar Item</button>
  </div>

  <p>Quando voc√™ abrir o carrinho, pode compartilhar, atualizar e limpar seguindo as regras.</p>
</main>

<!-- Overlay -->
<div id="cartOverlay" onclick="closeCart()"></div>

<!-- Painel do carrinho -->
<div id="cartPanel">
  <div id="cartHeader">
    <h2 style="margin:0;">Meu Carrinho</h2>
    <button class="close-btn" onclick="closeCart()">X</button>
  </div>
  <div id="cartBody">
    <!-- Itens ir√£o aqui -->
    <div id="cartItems"></div>
  </div>
  <div id="cartFooter">
    <!-- Campos de affiliate/agent + bot√µes -->
    <div class="inline-form">
      <label for="affiliateId">Affiliate:</label>
      <input type="text" id="affiliateId" value="aff123">
      <label for="agentId">Agent:</label>
      <input type="text" id="agentId" value="agt567">
    </div>
    <button class="btn" style="margin-top:10px;" onclick="shareCart()">Compartilhar Carrinho</button>
    <button class="danger btn" style="margin-top:10px;" onclick="clearCartServer()">Limpar Carrinho</button>
  </div>
</div>

<script>
  /* Ajustar p/ seu backend Node */
  const BASE_URL = "http://localhost:3000";

  /* Itens do carrinho local (nao salva preco) = { type, category, nameDays, adults, children } */
  let cart = [];
  let shareId = null; // guardamos se ja compartilhado

  /* Ao carregar, checa se tem shareId na URL ou localStorage, e carrega do server */
  window.onload = () => {
    const localShare = localStorage.getItem("shareId");
    if(localShare) {
      shareId = localShare;
      loadCartFromServer(shareId);
    }
    // Se a URL tiver ?shareId=..., prioriza
    const params = new URLSearchParams(window.location.search);
    const paramShare = params.get("shareId");
    if(paramShare) {
      shareId = paramShare;
      localStorage.setItem("shareId", shareId);
      loadCartFromServer(shareId);
    }
    renderCart();
  };

  /* ABRIR / FECHAR Carrinho */
  function openCart() {
    document.getElementById("cartOverlay").style.display = "block";
    const panel = document.getElementById("cartPanel");
    panel.classList.add("open");
    panel.style.display = "flex";
  }
  function closeCart() {
    document.getElementById("cartOverlay").style.display = "none";
    const panel = document.getElementById("cartPanel");
    panel.classList.remove("open");
    panel.style.display = "flex"; // mantem flex pro anim
    panel.style.transform = "translateX(100%)";
    setTimeout(()=>{
      panel.style.display="none";
    },300);
  }

  /* ADICIONAR ITEM (local) */
  function addItem(){
    const type = document.getElementById("typeInput").value;
    const category = document.getElementById("categoryInput").value;
    const nameDays = document.getElementById("nameDaysInput").value;
    const adults = parseInt(document.getElementById("adultsInput").value)||0;
    const children = parseInt(document.getElementById("childrenInput").value)||0;

    const newItem = { type, category, nameDays, adults, children };
    cart.push(newItem);
    renderCart();
    // se ja tem shareId => updateCart
    updateCartServer();
    openCart();
  }

  /* RENDERIZAR CARRINHO */
  function renderCart(){
    const container = document.getElementById("cartItems");
    container.innerHTML = "";
    cart.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "cart-item";

      div.innerHTML = `
        <button class="remove-btn" onclick="removeItem(${index})">üóë</button>
        <p><strong>Type:</strong> ${item.type}</p>
        <p><strong>Categoria:</strong> ${item.category}</p>
        <p><strong>Nome/Dias:</strong> ${item.nameDays}</p>
        <div class="row">
          <div class="quantity-box">
            <label>Adultos:</label>
            <button onclick="decAdults(${index})">-</button>
            <span>${item.adults}</span>
            <button onclick="incAdults(${index})">+</button>
          </div>
          <div class="quantity-box">
            <label>Crian√ßas:</label>
            <button onclick="decChildren(${index})">-</button>
            <span>${item.children}</span>
            <button onclick="incChildren(${index})">+</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  /* FUN√á√ïES inc/dec */
  function incAdults(idx){
    cart[idx].adults++;
    renderCart();
    updateCartServer();
  }
  function decAdults(idx){
    if(cart[idx].adults>0) cart[idx].adults--;
    renderCart();
    updateCartServer();
  }
  function incChildren(idx){
    cart[idx].children++;
    renderCart();
    updateCartServer();
  }
  function decChildren(idx){
    if(cart[idx].children>0) cart[idx].children--;
    renderCart();
    updateCartServer();
  }

  /* REMOVER ITEM */
  function removeItem(idx){
    cart.splice(idx,1);
    renderCart();
    updateCartServer();
  }

  /* SHARE CART (Criar no DB) */
  async function shareCart(){
    if(cart.length===0){
      alert("Carrinho vazio, adicione itens antes de compartilhar.");
      return;
    }
    // Se ja existe shareId, so update
    if(shareId){
      alert("Carrinho ja possui shareId: "+shareId+" (basta mandar o link).");
      return;
    }
    const affiliateId = document.getElementById("affiliateId").value.trim();
    const agentId = document.getElementById("agentId").value.trim();
    if(!affiliateId || !agentId){
      alert("Informe affiliateId e agentId");
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/shareCart`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          affiliateId,
          agentId,
          items: cart
        })
      });
      const data = await resp.json();
      if(data.success){
        shareId = data.shareId;
        localStorage.setItem("shareId", shareId);
        const shareUrl = window.location.origin+window.location.pathname+"?shareId="+shareId;
        alert("Carrinho compartilhado!\nLink: "+shareUrl);
      } else {
        alert("Erro: "+ data.error);
      }
    } catch(err){
      console.error(err);
      alert("Falha ao compartilhar carrinho!");
    }
  }

  /* updateCartServer => se shareId existe, chamamos /updateCart p/ manter item e quant */
  async function updateCartServer(){
    if(!shareId) return; // so atualiza se ja compartilhado
    try {
      const resp = await fetch(`${BASE_URL}/updateCart`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          shareId,
          items: cart
        })
      });
      const data = await resp.json();
      if(!data.success){
        console.error("Erro updateCart:", data.error);
      }
    } catch(err){
      console.error("Falha updateCart:",err);
    }
  }

  /* Carrega carrinho de um shareId do server */
  async function loadCartFromServer(sId){
    try {
      const resp = await fetch(`${BASE_URL}/cart/${sId}`);
      const data = await resp.json();
      if(!data.success){
        console.error("Erro loadCart:", data.error);
        return;
      }
      // data.items => array
      cart = data.items; 
      renderCart();
    } catch(err){
      console.error("Falha loadCart:",err);
    }
  }

  /* Limpar Carrinho => /clearCart e localStorage */
  async function clearCartServer(){
    if(!shareId){
      // Se nao temos shareId, so limpa local
      cart = [];
      renderCart();
      alert("Carrinho local limpo!");
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/clearCart`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ shareId })
      });
      const data = await resp.json();
      if(data.success){
        alert("Carrinho removido do servidor!");
        // zera local
        cart = [];
        renderCart();
        // remove shareId
        shareId = null;
        localStorage.removeItem("shareId");
      } else {
        alert("Erro ao limpar: "+ (data.error||"desconhecido"));
      }
    } catch(err){
      console.error("Falha clearCart:",err);
    }
  }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Carrinho Suspenso (Layout Exemplo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* RESET / BASE */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
    }

    /* CABEÇALHO */
    header {
      background: #fff;
      border-bottom: 1px solid #eee;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }
    .cart-btn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cart-btn:hover {
      background: #005bb5;
    }

    /* CONTEÚDO PRINCIPAL */
    main {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .new-item-form {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
    }
    .new-item-form h2 {
      margin: 0 0 1rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .form-row {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .form-row label {
      min-width: 80px;
      font-weight: 500;
      color: #555;
    }
    .form-row input {
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
      font-size: 0.9rem;
      transition: border 0.2s;
    }
    .form-row input:focus {
      border-color: #007bff;
    }
    .btn-primary {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary:hover {
      background: #005bb5;
    }

    /* OVERLAY E CART PANEL */
    #cartOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 1000;
    }
    #cartPanel {
      position: fixed;
      top: 0; right: 0;
      width: 360px;
      height: 100vh;
      background: #fff;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1010;
    }
    #cartPanel.open {
      transform: translateX(0);
    }

    /* HEADER DO CARRINHO */
    .cart-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-header .title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0;
    }
    .cart-header button {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #999;
      cursor: pointer;
    }
    .cart-header button:hover {
      color: #666;
    }

    /* CORPO DO CARRINHO */
    .cart-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #fafafa;
    }
    .alert-green {
      background: #ebfaeb;
      border: 1px solid #c8eac7;
      border-radius: 6px;
      padding: 0.6rem;
      font-size: 0.8rem;
      color: #2a942f;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .alert-green .timer {
      font-weight: 600;
      margin-left: 1rem;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: #444;
    }

    /* ITENS */
    .cart-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .cart-item:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .trash-btn {
      position: absolute;
      top: 10px; 
      right: 10px;
      background: none;
      border: none;
      font-size: 1rem;
      color: #999;
      cursor: pointer;
      transition: color 0.2s;
    }
    .trash-btn:hover {
      color: #e00;
    }
    .tag-ingresso {
      display: inline-block;
      background: #ffefcc;
      color: #ff9900;
      border: 1px solid #ffd899;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 12px;
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }
    .item-title {
      font-weight: 600;
      margin: 0.2rem 0;
      color: #333;
    }
    .item-details {
      display: flex;
      gap: 8px;
      font-size: 0.8rem;
      color: #666;
      margin: 0.3rem 0;
    }
    .item-price {
      position: absolute;
      right: 1rem; 
      bottom: 1rem;
      font-weight: 600;
      font-size: 0.85rem;
      color: #333;
    }

    /* RODAPÉ: SUBTOTAL, DESCONTO, TOTAL */
    .price-line {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }
    .price-line .green {
      color: #2a942f;
      font-weight: 600;
    }
    .total-line {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin: 0.5rem 0 1rem;
    }
    .checkout-btn {
      width: 100%;
      background: #35b473;
      border: none;
      color: #fff;
      font-size: 0.9rem;
      border-radius: 6px;
      padding: 0.7rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkout-btn:hover {
      background: #2d9e64;
    }

    /* FOOTER DO CARRINHO */
    .cart-footer {
      border-top: 1px solid #eee;
      padding: 1rem;
      background: #fff;
    }
    .footer-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .footer-actions input {
      flex: 1;
      min-width: 0;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .footer-actions .btn-mini {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .footer-actions .btn-mini:hover {
      background: #005bb5;
    }
    .footer-actions .btn-mini-danger {
      background: #d93025;
    }
    .footer-actions .btn-mini-danger:hover {
      background: #b0241a;
    }

  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1>Carrinho Suspenso (Exemplo)</h1>
  <button id="openCartBtn" class="cart-btn">Meu Carrinho</button>
</header>

<!-- MAIN -->
<main>
  <div class="new-item-form">
    <h2>Novo Item</h2>

    <div class="form-row">
      <label>Type:</label>
      <input type="text" id="typeInput" value="Ingressos">
    </div>
    <div class="form-row">
      <label>Categoria:</label>
      <input type="text" id="categoryInput" value="Walt Disney World">
    </div>
    <div class="form-row">
      <label>Nome e Dias:</label>
      <input type="text" id="nameDaysInput" value="1 DIA MAGIC KINGDOM">
    </div>
    <div class="form-row">
      <label>Data:</label>
      <input type="date" id="dateInput" value="2025-04-12">
    </div>
    <div class="form-row">
      <label>Adultos:</label>
      <input type="number" id="adultsInput" value="1" min="0" style="width:60px;">
      <label>Crianças:</label>
      <input type="number" id="childrenInput" value="0" min="0" style="width:60px;">
    </div>
    <button class="btn-primary" onclick="addItem()">Adicionar Item</button>
  </div>
</main>

<!-- OVERLAY -->
<div id="cartOverlay" onclick="closeCart()"></div>

<!-- CART PANEL -->
<div id="cartPanel">
  <!-- HEADER DO CARRINHO -->
  <div class="cart-header">
    <span class="title">Resumo do pedido</span>
    <button onclick="closeCart()">✕</button>
  </div>

  <!-- CORPO DO CARRINHO -->
  <div class="cart-body">
    <!-- Banner verde + timer -->
    <div class="alert-green">
      <span>Preço(s) atualizado(s) a cada 25. Garanta já o(s) produto(s) com o preço atual</span>
      <span class="timer" id="timerValue">01:02</span>
    </div>

    <div class="section-title" style="margin-top:0;">Ingressos</div>
    <div id="cartItems"></div>

    <!-- Subtotal, desconto, total -->
    <div class="price-line">
      <span>Subtotal</span>
      <span id="subtotalValue">R$ 0,00</span>
    </div>
    <div class="price-line">
      <span>Desconto</span>
      <span class="green" id="discountValue">- R$ 0,00</span>
    </div>
    <div class="total-line">
      <span>Total do pedido</span>
      <span id="totalValue">R$ 0,00</span>
    </div>

    <button class="checkout-btn">Ir para o checkout</button>
  </div>

  <!-- RODAPÉ DO CARRINHO -->
  <div class="cart-footer">
    <div class="footer-actions">
      <input type="text" id="affiliateId" value="aff123" placeholder="Affiliate">
      <input type="text" id="agentId" value="agt567" placeholder="Agent">
    </div>
    <div class="footer-actions">
      <button class="btn-mini" onclick="shareCart()">Compartilhar</button>
      <button class="btn-mini btn-mini-danger" onclick="clearCartServer()">Limpar</button>
    </div>
  </div>
</div>

<script>
  /* Ajustar p/ seu backend Node */
  const BASE_URL = "http://localhost:3000";

  /* 
    Carrinho local => { type, category, nameDays, date, adults, children }
    shareId => null até /shareCart
  */
  let cart = [];
  let shareId = null;

  // Ao carregar, checa localStorage e ?shareId
  window.onload = () => {
    const localS = localStorage.getItem("shareId");
    if(localS){
      shareId = localS;
      loadCartFromServer(shareId);
    }
    const params = new URLSearchParams(window.location.search);
    const paramS = params.get("shareId");
    if(paramS){
      shareId = paramS;
      localStorage.setItem("shareId", shareId);
      loadCartFromServer(shareId);
    }
    renderCart();
  };

  // Abrir/fechar
  document.getElementById("openCartBtn").addEventListener("click", openCart);
  function openCart(){
    document.getElementById("cartOverlay").style.display = "block";
    document.getElementById("cartPanel").classList.add("open");
  }
  function closeCart(){
    document.getElementById("cartOverlay").style.display = "none";
    document.getElementById("cartPanel").classList.remove("open");
  }

  // Adicionar item
  function addItem(){
    const type = document.getElementById("typeInput").value.trim();
    const category = document.getElementById("categoryInput").value.trim();
    const nameDays = document.getElementById("nameDaysInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const adults = parseInt(document.getElementById("adultsInput").value)||0;
    const children = parseInt(document.getElementById("childrenInput").value)||0;

    const newItem = { type, category, nameDays, date, adults, children };
    cart.push(newItem);
    renderCart();
    updateCartServer();
    openCart();
  }

  // Render local
  function renderCart(){
    const container = document.getElementById("cartItems");
    container.innerHTML = "";
    let sub = 0;

    cart.forEach((item, idx) => {
      // Exemplo de preço local (sem DB): adult=100, child=60
      const itemPrice = (item.adults * 100) + (item.children * 60);
      sub += itemPrice;

      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <button class="trash-btn" onclick="removeItem(${idx})">🗑</button>
        <span class="tag-ingresso">${item.type}</span>
        <div class="item-title">${item.category} - ${item.nameDays}</div>
        <div class="item-details">
          <span>${item.date}</span>
          <span>${item.children} Crianças</span>
          <span>${item.adults} Adulto(s)</span>
        </div>
        <span class="item-price">R$ ${itemPrice.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
      `;
      container.appendChild(div);
    });

    // Exemplo de 10% de desconto
    const discount = sub * 0.10;
    const total = sub - discount;
    document.getElementById("subtotalValue").textContent = "R$ " + sub.toLocaleString('pt-BR',{minimumFractionDigits:2});
    document.getElementById("discountValue").textContent = "- R$ " + discount.toLocaleString('pt-BR',{minimumFractionDigits:2});
    document.getElementById("totalValue").textContent = "R$ " + total.toLocaleString('pt-BR',{minimumFractionDigits:2});
  }

  function removeItem(idx){
    cart.splice(idx,1);
    renderCart();
    updateCartServer();
  }

  // shareCart
  async function shareCart(){
    if(cart.length===0){
      alert("Carrinho vazio!");
      return;
    }
    if(shareId){
      alert("Carrinho já possui shareId: "+shareId);
      return;
    }
    const affiliateId = document.getElementById("affiliateId").value.trim();
    const agentId = document.getElementById("agentId").value.trim();
    if(!affiliateId || !agentId){
      alert("Informe affiliateId e agentId!");
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/shareCart`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          affiliateId,
          agentId,
          items: cart
        })
      });
      const data = await resp.json();
      if(data.success){
        shareId = data.shareId;
        localStorage.setItem("shareId", shareId);
        const link = window.location.origin+window.location.pathname+"?shareId="+shareId;
        alert("Carrinho compartilhado!\n"+link);
      } else {
        alert("Erro ao compartilhar: "+(data.error||"desconhecido"));
      }
    } catch(e){
      console.error(e);
      alert("Falha ao compartilhar!");
    }
  }

  // updateCart se shareId
  async function updateCartServer(){
    if(!shareId) return;
    try {
      const resp = await fetch(`${BASE_URL}/updateCart`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ shareId, items: cart })
      });
      const data = await resp.json();
      if(!data.success){
        console.error("Erro updateCart:", data.error);
      }
    } catch(e){
      console.error(e);
    }
  }

  // loadCartFromServer
  async function loadCartFromServer(sId){
    try {
      const resp = await fetch(`${BASE_URL}/cart/${sId}`);
      const data = await resp.json();
      if(!data.success){
        console.error("Erro loadCart:", data.error);
        return;
      }
      cart = data.items;
      renderCart();
    } catch(e){
      console.error(e);
    }
  }

  // clearCart
  async function clearCartServer(){
    if(!shareId){
      cart = [];
      renderCart();
      alert("Carrinho local limpo!");
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/clearCart`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ shareId })
      });
      const data = await resp.json();
      if(data.success){
        alert("Carrinho removido do servidor!");
        cart = [];
        renderCart();
        shareId = null;
        localStorage.removeItem("shareId");
      } else {
        alert("Erro ao limpar: "+(data.error||"desconhecido"));
      }
    } catch(e){
      console.error(e);
    }
  }
</script>
</body>
</html>
